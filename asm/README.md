# Code generation

Most of the optimized assembly primitives provided in this repository are auto-generated from scripts using a small
Python 3 code generation framework. This directory contains those scripts, the underlying framework, as well as the
auto-generated assembly files.

## Structure

### Code generation

[`gen`](gen/) contains Python classes supporting the development of optimized assembly:

* [`gen/core`](gen/core) contains some generic helper classes which are hoped to be useful independently of a specific choice
  of ISA: For example, [register management](gen/core/regs.py), management of index-to-register mappings for
  [loading buffers into (vector) registers](gen/core/rw.py), or setup of [address marker
  registers](core/markers.py) in case a buffer needs to be randomly addressed whose size exceeds the immediate
  offset bounds of the underlying ISA.
* [`gen/mve/`](gen/mve/) contains some MVE-specific helper classes, such as a [register allocator](gen/mve/regs.py) for GPR and Vector file, and
  helpers for [reading/writing buffers to/from vector registers](gen/mve/rw.py).

### Scripts

[`scripts`](scripts) is the heart of this repository, containing code generation scripts for various
algorithms around polynomial multiplication or the PQC schemes they're relevant for, as well as other tests and
examples. Those scripts build on the generic framework provided by [`gen`](gen/).

- [`scripts/poly-simd`](scripts/poly-simd/) (assembly [here](auto/poly/simd/)): Vectorized implementation of low to mid
  degree (<= 64) polynomial multiplication. This is intended to be used as the 'base' multiplication after dimension
  reduction through Toom-Karatsuba.
- [`scripts/toom3`](scripts/toom3/) (assembly [here](auto/poly/toom3/)): Vectorized implementation of the
  [evaluation](scripts/toom3/evaluation.py) and [interpolation](scripts/toom3/interpolation.py)
  steps for the [Toom-Cook](https://en.wikipedia.org/wiki/Toom%E2%80%93Cook_multiplication) 3-way multiplication
  approach, reducing a polynomial multiplication of degree `3*N` to `5` polynomial multiplications of degree `N`,
  plus some additive arithmetic.
- [`scripts/toom4`](scripts/toom4/) (assembly [here](auto/poly/toom4/)): Vectorized implementation of the
  [evaluation](scripts/toom4/evaluation.py) and [interpolation](scripts/toom4/interpolation.py)
  [Toom-Cook](https://en.wikipedia.org/wiki/Toom%E2%80%93Cook_multiplication) 4-way multiplication approach,
  reducing a polynomial multiplication of degree `4*N` to `7` polynomial multiplications of degree `N`, plus some
  additive arithmetic.
- [`scripts/ntt`](scripts/ntt/) (assembly [here](auto/ntt/ntt.s): Vectorized implementation of the Number Theoretic Transform
  (NTT).
- [`scripts/poly`](scripts/poly/): An abandoned approach for vectorizing (quadratic) column-wise approach
  polynomial multiplication.

See the respective directories for more information.

Additionally, there are small example scripts in [`examples/`](examples/) which test and exemplify the use of
the code generation classes from [`gen`](gen/):

- [`examples/permute`](examples/permute/) (assembly [here](auto/permute/)): An example of how to use markers
  from [`gen/core/markers`](gen/core/markers.py) to simplify random access to buffers are too larger to be accessed
  through a single base address and immediate offset (which in MVE is limited -127,...,127).
- [`examples/transpose`](examples/transpose/) (assembly [here](auto/transpose/)): An example of how to use support for
  non-contiguous buffers in the buffer reader class from [`gen/mve/rw`](gen/mve/rw.py) to implement a matrix transposition.

### Autogenerated files

[`auto/`](auto/) contains the assembly auto-generated by the examples in [`scripts`](scripts/). Its structure mirrors that of [`scripts`](scripts/).
